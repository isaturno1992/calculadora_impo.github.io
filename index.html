<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Costos de Importación - Uruguay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        
        /* Estilos de Tooltip Global */
        #shared-tooltip {
            position: absolute;
            display: none;
            background-color: #1f2937; /* bg-gray-800 */
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 50;
            max-width: 250px;
            pointer-events: none; /* Para que no interfiera con otros clics */
        }
        #shared-tooltip::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 100%; /* Posiciona la flecha abajo */
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
    </style>
</head>
<body class="bg-white"> <!-- Fondo blanco para que combine con el contenedor -->

    <!-- Contenedor principal de ancho completo -->
    <div class="min-h-screen">
        
        <!-- Encabezado Oscuro (ancho completo) -->
        <header class="bg-gray-900 shadow-md">
            <!-- CORRECCIÓN: Contenido ahora fluido, solo con padding lateral -->
            <div class="px-6 py-5">
                <h1 class="text-2xl font-bold text-white">Calculadora de Costos de Importación</h1>
                <p class="text-sm text-gray-300">Estimador de costos para importaciones a Uruguay.</p>
            </div>
        </header>

        <!-- Navegación de Pestañas (ancho completo) -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-10">
            <!-- CORRECCIÓN: Contenido ahora fluido, solo con padding lateral -->
            <div class="px-4 sm:px-6 lg:px-8">
                <!-- CORRECCIÓN: Se quita el max-w-2xl para que las pestañas se centren en el ancho completo -->
                <div class="flex justify-center space-x-2 md:space-x-4 py-3">
                    
                    <!-- Pestaña 1: Activa por defecto -->
                    <button id="tab-1" class="pill-btn flex-1 flex justify-center items-center gap-2 py-2 px-3 rounded-full text-sm font-medium transition-all duration-200 ease-in-out bg-indigo-600 text-white shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10H3"/><path d="M21 6H3"/><path d="M21 14H3"/><path d="M21 18H3"/></svg>
                        <span class="hidden sm:inline">1. Embarque</span>
                    </button>
                    
                    <!-- Pestaña 2 -->
                    <button id="tab-2" class="pill-btn flex-1 flex justify-center items-center gap-2 py-2 px-3 rounded-full text-sm font-medium transition-all duration-200 ease-in-out text-gray-600 hover:bg-gray-100 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                        <span class="hidden sm:inline">2. Productos</span>
                    </button>
                    
                    <!-- Pestaña 3 -->
                    <button id="tab-3" class="pill-btn flex-1 flex justify-center items-center gap-2 py-2 px-3 rounded-full text-sm font-medium transition-all duration-200 ease-in-out text-gray-600 hover:bg-gray-100 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16"/><path d="M2 10h20"/><path d="m4 10 0-6 3 0"/><path d="m10 4 0 6"/><path d="m17 4 0 6"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                        <span class="hidden sm:inline">3. Impuestos</span>
                    </button>
                    
                    <!-- Pestaña 4 -->
                    <button id="tab-4" class="pill-btn flex-1 flex justify-center items-center gap-2 py-2 px-3 rounded-full text-sm font-medium transition-all duration-200 ease-in-out text-gray-600 hover:bg-gray-100 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/><path d="M11 3h10v5"/></svg>
                        <span class="hidden sm:inline">4. Resultados</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- CORRECCIÓN: Contenedor de Pasos ahora fluido, solo con padding -->
        <main class="p-4 md:p-8 bg-gray-50"> <!-- Fondo gris claro para el área de contenido -->

            <!-- PASO 1: EMBARQUE -->
            <div id="step-1" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Configuración General -->
                        <div class="bg-white border border-gray-200 rounded-lg p-5">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Configuración General</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="incoterm" class="block text-sm font-medium text-gray-700">Incoterm</label>
                                    <select id="incoterm" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                        <option value="FOB">FOB (Free On Board)</option>
                                        <option value="EXW">EXW (Ex Works)</option>
                                        <option value="CFR">CFR (Cost and Freight)</option>
                                        <option value="CIF">CIF (Cost, Insurance, Freight)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="tipo-cambio" class="block text-sm font-medium text-gray-700">Tipo de Cambio (USD → UYU)</label>
                                    <input type="number" id="tipo-cambio" placeholder="Ej: 39.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <p id="tipo-cambio-error" class="text-xs text-red-600 hidden mt-1">El tipo de cambio es obligatorio.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Costos Adicionales en Origen -->
                        <div class="bg-white border border-gray-200 rounded-lg p-5">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Costos Adicionales en Origen (USD)</h2>
                            <p class="text-sm text-gray-500 mb-4">Visibles según el Incoterm seleccionado.</p>
                            <div id="costos-origen-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Campos dinámicos de costos -->
                            </div>
                        </div>
                    </div>

                    <!-- Resumen del Embarque -->
                    <div class="lg:col-span-1">
                        <div class="bg-white border border-gray-200 rounded-lg p-5 sticky top-28"> <!-- Ajustado sticky top -->
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Resumen del Embarque</h2>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Valor Base (según Incoterm)</span>
                                    <span class="text-sm font-medium text-gray-900" id="resumen-valor-base">USD $0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Costos Origen</span>
                                    <span class="text-sm font-medium text-gray-900" id="resumen-costos-origen">USD $0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Flete</span>
                                    <span class="text-sm font-medium text-gray-900" id="resumen-flete">USD $0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Seguro</span>
                                    <span class="text-sm font-medium text-gray-900" id="resumen-seguro">USD $0.00</span>
                                </div>
                                <div class="border-t border-gray-200 pt-3 mt-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-base font-semibold text-gray-900">
                                            Valor CIF Total
                                            <span class="tooltip-trigger text-indigo-600 cursor-pointer" data-tooltip="Costo + Seguro + Flete. Es la base imponible para la mayoría de los impuestos.">(?)</span>
                                        </span>
                                        <span class="text-xl font-bold text-indigo-600" id="resumen-cif-total">USD $0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PASO 2: PRODUCTOS -->
            <div id="step-2" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <!-- Detalle de Productos -->
                        <div class="bg-white border border-gray-200 rounded-lg p-5">
                            <h2 class="text-lg font-semibold text-gray-900 mb-2">Detalle de Productos</h2>
                            <p class="text-sm text-gray-500 mb-4">Añada los productos de su embarque. El Valor CIF se asignará a cada uno.</p>
                            
                            <!-- Selectores de Prorrateo -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="modo-dai" class="block text-sm font-medium text-gray-700">Modo de Cálculo DAI:</label>
                                    <select id="modo-dai" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                        <option value="producto">Por Producto (en tabla)</option>
                                        <option value="global">Global (en Paso 3)</option>
                                    </select>
                                </div>
                                <p class="text-sm text-gray-500 md:mt-6">
                                    <span class="font-medium">Prorrateo Costos CIF por:</span><br>
                                    Automáticamente por <span class="font-semibold">CBM (m³)</span>
                                </p>
                            </div>

                            <!-- Tabla de Productos -->
                            <div class="overflow-x-auto -mx-5 px-5">
                                <table class="min-w-full divide-y divide-gray-200 mb-4">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[150px]">Producto</th>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">NCM <span class="tooltip-trigger" data-tooltip="Nomenclatura Común del Mercosur. Código de 8 a 10 dígitos.">(?)</span></th>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[80px]">Cantidad</th>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">Precio Unit.</th>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">CBM (m³) <span class="tooltip-trigger" data-tooltip="Metros Cúbicos. Es el volumen que ocupa el producto.">(?)</span></th>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[80px] dai-column">DAI (%) <span class="tooltip-trigger" data-tooltip="Derecho Aduanero de Importación (Arancel). Varía según el NCM.">(?)</span></th>
                                            <th class="py-3 px-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="product-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Filas de productos se insertan aquí -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="flex flex-wrap gap-2">
                                <button id="add-product" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md text-sm">+ Añadir Producto</button>
                                <button id="import-excel" class="bg-gray-700 hover:bg-gray-800 text-white font-medium py-2 px-4 rounded-md text-sm">Importar Excel</button>
                                <button id="download-template" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-md text-sm">Descargar Plantilla</button>
                                <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="hidden">
                            </div>

                        </div>
                    </div>
                    
                    <!-- Resumen de Productos -->
                    <div class="lg:col-span-1">
                        <div class="bg-white border border-gray-200 rounded-lg p-5 sticky top-28"> <!-- Ajustado sticky top -->
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Resumen de Productos</h2>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Total Valor Base</span>
                                    <span class="text-lg font-bold text-indigo-600" id="total-valor-base">USD $0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Total CBM (m³) <span class="tooltip-trigger" data-tooltip="Volumen total del embarque.">(?)</span></span>
                                    <span class="text-lg font-bold text-indigo-600" id="total-cbm">0.00 m³</span>
                                </div>
                                <p class="text-xs text-gray-500 pt-4 border-t border-gray-100">
                                    Este "Total Valor Base" debe coincidir con el "Valor Base" del Paso 1 para un Incoterm FOB.
                                </p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- PASO 3: IMPUESTOS Y GASTOS -->
            <div id="step-3" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">

                        <!-- PASO 3a: IMPUESTOS Y GASTOS DE NACIONALIZACIÓN -->
                        <div class="bg-white border border-gray-200 rounded-lg p-5">
                            <h2 class="text-lg font-semibold text-gray-900 mb-2">Paso 3a: Impuestos y Gastos de Nacionalización</h2>
                            <p class="text-sm text-gray-500 mb-4">Costos para "liberar" la mercadería en Aduana.</p>

                            <!-- Modo de Cálculo -->
                            <div>
                                <label for="modo-calculo" class="block text-sm font-medium text-gray-700">Modo de Cálculo</label>
                                <select id="modo-calculo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option value="estimacion">Estimación (Automático)</option>
                                    <option value="liquidacion">Liquidación (Manual)</option>
                                </select>
                            </div>

                            <!-- Contenedor Estimación -->
                            <div id="estimacion-container" class="mt-6 space-y-4">
                                <h3 class="text-md font-semibold text-gray-800">Impuestos (Porcentajes)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="tasa-consular" class="block text-sm font-medium text-gray-700">Tasa Consular (%) <span class="tooltip-trigger" data-tooltip="Tasa Consular sobre el valor CIF.">(?)</span></label>
                                        <input type="number" id="tasa-consular" value="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="tasa-estadistica" class="block text-sm font-medium text-gray-700">Tasa Estadística (%) <span class="tooltip-trigger" data-tooltip="Tasa Estadística sobre el valor CIF.">(?)</span></label>
                                        <input type="number" id="tasa-estadistica" value="0.2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="iva-porcentaje" class="block text-sm font-medium text-gray-700">IVA (%) <span class="tooltip-trigger" data-tooltip="Impuesto al Valor Agregado. Se calcula sobre (CIF + Arancel + Tasas).">(?)</span></label>
                                        <input type="number" id="iva-porcentaje" value="22" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="anticipo-iva" class="block text-sm font-medium text-gray-700">Anticipo IVA (%) <span class="tooltip-trigger" data-tooltip="Anticipo de IVA sobre el monto de IVA.">(?)</span></label>
                                        <input type="number" id="anticipo-iva" value="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    </div>
                                    <div id="dai-global-container" class="hidden">
                                        <label for="dai-global" class="block text-sm font-medium text-gray-700">DAI Global (%) <span class="tooltip-trigger" data-tooltip="Arancel único para todos los productos.">(?)</span></label>
                                        <input type="number" id="dai-global" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    </div>
                                </div>
                                <h3 class="text-md font-semibold text-gray-800 pt-4 border-t">Gastos de Nacionalización (Estimados)</h3>
                                <!-- Campos de gasto con toggle de moneda -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                    <!-- Despachante -->
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">Despachante</label>
                                            <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3a" data-state-key="despachante">
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                            </div>
                                        </div>
                                        <input type="number" id="gasto-despachante" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    </div>
                                    <!-- Agencia / Terminal -->
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">Agencia / Terminal</label>
                                            <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3a" data-state-key="agencia">
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                            </div>
                                        </div>
                                        <input type="number" id="gasto-agencia" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    </div>
                                    <!-- Otros Gastos -->
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">Otros Gastos Nacionalización</label>
                                            <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3a" data-state-key="otrosNac">
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                            </div>
                                        </div>
                                        <input type="number" id="gasto-otros-nac" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    </div>
                                </div>
                            </div>

                            <!-- Contenedor Liquidación -->
                            <div id="liquidacion-container" class="hidden mt-6 space-y-4">
                                <!-- Modo de Ingreso Manual -->
                                <div>
                                    <label for="modo-ingreso-manual" class="block text-sm font-medium text-gray-700">Modo de Ingreso (Aranceles + Gastos)</label>
                                    <select id="modo-ingreso-manual" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                        <option value="detallado">Detallado</option>
                                        <option value="total">Monto Total</option>
                                    </select>
                                </div>

                                <!-- Total (Manual) -->
                                <div id="manual-total-container" class="hidden">
                                    <h3 class="text-md font-semibold text-gray-800">Total (Manual)</h3>
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">Total Aranceles + Gastos (sin IVA)</label>
                                            <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3a" data-state-key="manualTotal">
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                            </div>
                                        </div>
                                        <input type="number" id="manual-total" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    </div>
                                </div>

                                <!-- Detallado (Manual) -->
                                <div id="manual-detallado-container" class="space-y-4">
                                    <h3 class="text-md font-semibold text-gray-800">Detallado (Manual)</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                        <!-- Arancel -->
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                                <label class="block text-sm font-medium text-gray-700">Arancel/Tasas DNA (DAI+TC+TE)</label>
                                                <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3a" data-state-key="manualArancel">
                                                    <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                                    <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                                </div>
                                            </div>
                                            <input type="number" id="manual-arancel" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </div>
                                        <!-- Despachante -->
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                                <label class="block text-sm font-medium text-gray-700">Despachante</label>
                                                <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3a" data-state-key="manualDespachante">
                                                    <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                                    <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                                </div>
                                            </div>
                                            <input type="number" id="manual-despachante" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </div>
                                        <!-- Agencia -->
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                                <label class="block text-sm font-medium text-gray-700">Agencia / Terminal</label>
                                                <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3a" data-state-key="manualAgencia">
                                                    <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                                    <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                                </div>
                                            </div>
                                            <input type="number" id="manual-agencia" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </div>
                                        <!-- Otros -->
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                                <label class="block text-sm font-medium text-gray-700">Otros Gastos Nacionalización</label>
                                                <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3a" data-state-key="manualOtrosNac">
                                                    <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                                    <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                                </div>
                                            </div>
                                            <input type="number" id="manual-otros-nac" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </div>
                                    </div>
                                </div>

                                <!-- Impuestos (Manual) -->
                                <h3 class="text-md font-semibold text-gray-800 pt-4 border-t">Impuestos (Manual)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                    <!-- IVA -->
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">IVA (Monto)</label>
                                            <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3a" data-state-key="manualIva">
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                            </div>
                                        </div>
                                        <input type="number" id="manual-iva" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    </div>
                                    <!-- Anticipo -->
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">Anticipo IVA (Monto)</label>
                                            <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3a" data-state-key="manualAnticipo">
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                                <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                            </div>
                                        </div>
                                        <input type="number" id="manual-anticipo" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PASO 3b: GASTOS POST-PUERTO -->
                        <div class="bg-white border border-gray-200 rounded-lg p-5">
                            <h2 class="text-lg font-semibold text-gray-900 mb-2">Paso 3b: Gastos Post-Puerto</h2>
                            <p class="text-sm text-gray-500 mb-4">Costos para "retirar" la mercadería.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                <!-- Almacenaje -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-sm font-medium text-gray-700">Almacenaje / Depósito</label>
                                        <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3b" data-state-key="almacenaje">
                                            <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                            <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                        </div>
                                    </div>
                                    <input type="number" id="gasto-almacenaje" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                </div>
                                <!-- Transporte Final -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-sm font-medium text-gray-700">Transporte Local (Final)</label>
                                        <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3b" data-state-key="transporte">
                                            <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                            <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                        </div>
                                    </div>
                                    <input type="number" id="gasto-transporte" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                </div>
                                <!-- Otros -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-sm font-medium text-gray-700">Otros Gastos Post-Puerto</label>
                                        <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-full currency-toggle-group" data-state-object="gastos3b" data-state-key="otrosPost">
                                            <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="USD">USD</button>
                                            <button class="currency-btn flex-1 py-1 px-3 rounded-full text-sm font-medium" data-moneda="UYU">$U</button>
                                        </div>
                                    </div>
                                    <input type="number" id="gasto-otros-post" value="0" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <!-- Lateral Paso 3 -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-5 sticky top-28"> <!-- Ajustado sticky top -->
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Recuperación de Impuestos</h2>
                            <div class="space-y-3">
                                
                                <!-- Toggle "borne" -->
                                <div class="flex justify-between items-center">
                                    <label for="recupera-iva" class="text-sm font-medium text-gray-700">¿Recupera IVA?</label>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="recupera-iva" class="sr-only peer" checked>
                                        <label for="recupera-iva" class="relative block w-10 h-6 bg-gray-200 rounded-full cursor-pointer transition-colors duration-200 ease-in-out peer-checked:bg-indigo-600">
                                            <span class="absolute left-0 top-0.5 w-5 h-5 bg-white border border-gray-300 rounded-full shadow-md transition-transform duration-200 ease-in-out peer-checked:translate-x-full peer-checked:border-white"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Toggle "borne" -->
                                <div class="flex justify-between items-center">
                                    <label for="recupera-anticipo" class="text-sm font-medium text-gray-700">¿Recupera Anticipo IVA?</label>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="recupera-anticipo" class="sr-only peer" checked>
                                        <label for="recupera-anticipo" class="relative block w-10 h-6 bg-gray-200 rounded-full cursor-pointer transition-colors duration-200 ease-in-out peer-checked:bg-indigo-600">
                                            <span class="absolute left-0 top-0.5 w-5 h-5 bg-white border border-gray-300 rounded-full shadow-md transition-transform duration-200 ease-in-out peer-checked:translate-x-full peer-checked:border-white"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-lg p-5 sticky top-64"> <!-- Ajustado sticky top -->
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Prorrateo de Gastos</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="prorrateo-gastos-3a" class="block text-sm font-medium text-gray-700">Prorratear Gastos 3a (Nacionalización) por:</label>
                                    <select id="prorrateo-gastos-3a" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        <option value="valor">Valor Base (USD)</option>
                                        <option value="cbm">CBM (m³)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="prorrateo-gastos-3b" class="block text-sm font-medium text-gray-700">Prorratear Gastos 3b (Post-Puerto) por:</label>
                                    <select id="prorrateo-gastos-3b" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        <option value="cbm">CBM (m³)</option>
                                        <option value="valor">Valor Base (USD)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PASO 4: RESULTADOS -->
            <div id="step-4" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Columna de Resúmenes -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Resultados Generales -->
                        <div class="bg-white border border-gray-200 rounded-lg p-5">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Resultados Generales</h2>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-gray-700">Costo Contable Neto <span class="tooltip-trigger" data-tooltip="Costo total sin impuestos recuperables. Úsalo para fijar tu precio de venta.">(?)</span></span>
                                    </div>
                                    <p class="text-2xl font-bold text-indigo-600" id="total-costo-neto-usd">USD $0.00</p>
                                    <p class="text-lg font-medium text-gray-600" id="total-costo-neto-uyu">UYU $ 0,00</p>
                                </div>
                                <div class="border-t border-gray-100 pt-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-gray-700">Desembolso Total <span class="tooltip-trigger" data-tooltip="El dinero total pagado (incluyendo IVA y Anticipos, aunque se recuperen).">(?)</span></span>
                                    </div>
                                    <p class="text-2xl font-bold text-gray-900" id="total-desembolso-usd">USD $0.00</p>
                                    <p class="text-lg font-medium text-gray-600" id="total-desembolso-uyu">UYU $ 0,00</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Composición del Costo -->
                        <div class="bg-white border border-gray-200 rounded-lg p-5">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Composición del Costo</h2>
                            <div class="w-full max-w-xs mx-auto">
                                <canvas id="cost-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Columna de Tabla de Costos -->
                    <div class="lg:col-span-2">
                        <div class="bg-white border border-gray-200 rounded-lg p-5">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold text-gray-900">Costos por Producto</h2>
                                <button id="export-excel" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md text-sm">Exportar a Excel</button>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor CIF (USD)</th>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Impuestos (USD)</th>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Gastos (USD)</th>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Neto Unitario (USD)</th>
                                            <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Neto Unitario (UYU)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Filas de resultados -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Botones de Guardado -->
            <footer class="mt-8 pt-6 border-t border-gray-200 flex flex-wrap items-center gap-2">
                <button id="guardar-calculo" class="bg-gray-800 hover:bg-gray-900 text-white font-medium py-2 px-4 rounded-md text-sm">Guardar Cálculo</button>
                <button id="cargar-calculo" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-md text-sm">Cargar Último</button>
                <button id="reset-todo" class="text-red-600 hover:text-red-800 font-medium text-sm ml-auto">Resetear Todo</button>
            </footer>
        </main>
    </div>

    <!-- Tooltip Global -->
    <div id="shared-tooltip" role="tooltip"></div>

    <script>
        // Objeto principal de la aplicación
        const app = {
            // Estado inicial de la aplicación
            state: {
                currentTab: 1,
                tipoCambio: null,
                incoterm: 'FOB',
                costosOrigen: {
                    retiro: 0,
                    transporte: 0,
                    despacho: 0,
                    thc: 0,
                    docs: 0,
                    flete: 0,
                    seguro: 0
                },
                productos: [],
                modoDai: 'producto', // 'producto' o 'global'
                recuperaIva: true,
                recuperaAnticipo: true,
                modoCalculo: 'estimacion', // 'estimacion' o 'liquidacion'
                modoIngresoManual: 'detallado', // 'detallado' o 'total'
                prorrateo3a: 'valor', // 'valor' o 'cbm'
                prorrateo3b: 'cbm', // 'valor' o 'cbm'
                impuestos: {
                    tasaConsular: 3,
                    tasaEstadistica: 0.2,
                    iva: 22,
                    anticipoIva: 10,
                    daiGlobal: 0
                },
                gastos3a: { // Nacionalización
                    despachante: 0, despachanteMoneda: 'USD',
                    agencia: 0, agenciaMoneda: 'USD',
                    otrosNac: 0, otrosNacMoneda: 'USD',
                    manualArancel: 0, manualArancelMoneda: 'USD',
                    manualDespachante: 0, manualDespachanteMoneda: 'USD',
                    manualAgencia: 0, manualAgenciaMoneda: 'USD',
                    manualOtrosNac: 0, manualOtrosNacMoneda: 'USD',
                    manualTotal: 0, manualTotalMoneda: 'USD',
                    manualIva: 0, manualIvaMoneda: 'USD',
                    manualAnticipo: 0, manualAnticipoMoneda: 'USD'
                },
                gastos3b: { // Post-Puerto
                    almacenaje: 0, almacenajeMoneda: 'USD',
                    transporte: 0, transporteMoneda: 'USD',
                    otrosPost: 0, otrosPostMoneda: 'USD'
                }
            },
            
            // Referencias a elementos del DOM
            elements: {
                tabs: [],
                steps: [],
                incoterm: null,
                tipoCambio: null,
                tipoCambioError: null,
                costosOrigenContainer: null,
                resumenValorBase: null,
                resumenCostosOrigen: null,
                resumenFlete: null,
                resumenSeguro: null,
                resumenCifTotal: null,
                productTableBody: null,
                addProductBtn: null,
                totalValorBase: null,
                totalCbm: null,
                modoDai: null,
                daiColumn: null,
                daiGlobalContainer: null,
                daiGlobal: null,
                // Paso 3
                modoCalculo: null,
                estimacionContainer: null,
                liquidacionContainer: null,
                modoIngresoManual: null,
                manualTotalContainer: null,
                manualDetalladoContainer: null,
                recuperaIva: null,
                recuperaAnticipo: null,
                prorrateo3a: null,
                prorrateo3b: null,
                // Paso 4
                resultsTableBody: null,
                totalCostoNetoUsd: null,
                totalCostoNetoUyu: null,
                totalDesembolsoUsd: null,
                totalDesembolsoUyu: null,
                costChartCanvas: null,
                costChart: null,
                // Guardado
                guardarBtn: null,
                cargarBtn: null,
                resetBtn: null,
                // Import/Export
                importExcelBtn: null,
                exportExcelBtn: null,
                downloadTemplateBtn: null,
                excelFileInput: null,
                // Tooltip
                sharedTooltip: null,
            },
            
            // Inicialización
            init() {
                try {
                    this.cacheElements();
                    this.setupListeners();
                    this.updateCostoFields();
                    this.renderProductTable();
                    this.calculateAll();
                    this.loadState(); // Cargar estado guardado al inicio
                    console.log("Calculadora inicializada.");
                } catch (error) {
                    console.error("Error fatal durante la inicialización:", error);
                    document.body.innerHTML = `<div class="p-4 bg-red-100 text-red-700">Error fatal: ${error.message}. Por favor, recargue la página.</div>`;
                }
            },
            
            // Guardar referencias a elementos comunes
            cacheElements() {
                this.elements.tabs = [document.getElementById('tab-1'), document.getElementById('tab-2'), document.getElementById('tab-3'), document.getElementById('tab-4')];
                this.elements.steps = [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3'), document.getElementById('step-4')];
                
                this.elements.incoterm = document.getElementById('incoterm');
                this.elements.tipoCambio = document.getElementById('tipo-cambio');
                this.elements.tipoCambioError = document.getElementById('tipo-cambio-error');
                this.elements.costosOrigenContainer = document.getElementById('costos-origen-container');
                
                this.elements.resumenValorBase = document.getElementById('resumen-valor-base');
                this.elements.resumenCostosOrigen = document.getElementById('resumen-costos-origen');
                this.elements.resumenFlete = document.getElementById('resumen-flete');
                this.elements.resumenSeguro = document.getElementById('resumen-seguro');
                this.elements.resumenCifTotal = document.getElementById('resumen-cif-total');
                
                this.elements.productTableBody = document.getElementById('product-table-body');
                this.elements.addProductBtn = document.getElementById('add-product');
                this.elements.totalValorBase = document.getElementById('total-valor-base');
                this.elements.totalCbm = document.getElementById('total-cbm');
                
                this.elements.modoDai = document.getElementById('modo-dai');
                this.elements.daiColumn = document.querySelectorAll('.dai-column');
                this.elements.daiGlobalContainer = document.getElementById('dai-global-container');
                this.elements.daiGlobal = document.getElementById('dai-global');
                
                this.elements.modoCalculo = document.getElementById('modo-calculo');
                this.elements.estimacionContainer = document.getElementById('estimacion-container');
                this.elements.liquidacionContainer = document.getElementById('liquidacion-container');
                this.elements.modoIngresoManual = document.getElementById('modo-ingreso-manual');
                this.elements.manualTotalContainer = document.getElementById('manual-total-container');
                this.elements.manualDetalladoContainer = document.getElementById('manual-detallado-container');
                
                this.elements.recuperaIva = document.getElementById('recupera-iva');
                this.elements.recuperaAnticipo = document.getElementById('recupera-anticipo');
                this.elements.prorrateo3a = document.getElementById('prorrateo-gastos-3a');
                this.elements.prorrateo3b = document.getElementById('prorrateo-gastos-3b');
                
                this.elements.resultsTableBody = document.getElementById('results-table-body');
                this.elements.totalCostoNetoUsd = document.getElementById('total-costo-neto-usd');
                this.elements.totalCostoNetoUyu = document.getElementById('total-costo-neto-uyu');
                this.elements.totalDesembolsoUsd = document.getElementById('total-desembolso-usd');
                this.elements.totalDesembolsoUyu = document.getElementById('total-desembolso-uyu');
                this.elements.costChartCanvas = document.getElementById('cost-chart');
                
                this.elements.guardarBtn = document.getElementById('guardar-calculo');
                this.elements.cargarBtn = document.getElementById('cargar-calculo');
                this.elements.resetBtn = document.getElementById('reset-todo');
                
                this.elements.importExcelBtn = document.getElementById('import-excel');
                this.elements.exportExcelBtn = document.getElementById('export-excel');
                this.elements.downloadTemplateBtn = document.getElementById('download-template');
                this.elements.excelFileInput = document.getElementById('excel-file-input');

                this.elements.sharedTooltip = document.getElementById('shared-tooltip');
            },
            
            // Configurar todos los listeners de eventos
            setupListeners() {
                try {
                    // Navegación
                    this.elements.tabs.forEach((tab, index) => {
                        tab.addEventListener('click', () => this.changeTab(index + 1));
                    });

                    // Tooltips (?)
                    document.querySelectorAll('.tooltip-trigger').forEach(trigger => {
                        const tooltipText = trigger.getAttribute('data-tooltip');
                        if (tooltipText) {
                            trigger.addEventListener('mouseover', (e) => this.showTooltip(e, tooltipText));
                            trigger.addEventListener('mouseout', () => this.hideTooltip());
                        }
                    });
                    
                    // Paso 1
                    this.elements.incoterm.addEventListener('change', (e) => {
                        this.state.incoterm = e.target.value;
                        this.updateCostoFields();
                        this.calculateAll();
                    });
                    this.elements.tipoCambio.addEventListener('input', (e) => {
                        this.state.tipoCambio = parseFloat(e.target.value) || null;
                        if (this.state.tipoCambio > 0) {
                            this.elements.tipoCambioError.classList.add('hidden');
                        }
                        this.calculateAll();
                    });
                    this.elements.costosOrigenContainer.addEventListener('input', (e) => {
                        if (e.target.id in this.state.costosOrigen) {
                            this.state.costosOrigen[e.target.id] = parseFloat(e.target.value) || 0;
                            this.calculateAll();
                        }
                    });
                    
                    // Paso 2
                    this.elements.addProductBtn.addEventListener('click', () => this.addProduct());
                    this.elements.productTableBody.addEventListener('change', (e) => {
                        if (e.target.classList.contains('product-input')) {
                            this.updateProductFromTable(e.target);
                        }
                    });
                    this.elements.productTableBody.addEventListener('click', (e) => {
                        if (e.target.closest('.remove-product')) {
                            this.removeProduct(e.target.closest('.remove-product').dataset.id);
                        }
                    });
                    this.elements.modoDai.addEventListener('change', (e) => {
                        this.state.modoDai = e.target.value;
                        this.updateDaiVisibility();
                        this.calculateAll();
                    });
                    
                    // Paso 3
                    this.elements.modoCalculo.addEventListener('change', (e) => {
                        this.state.modoCalculo = e.target.value;
                        this.updateModoCalculo();
                        this.calculateAll();
                    });
                    this.elements.modoIngresoManual.addEventListener('change', (e) => {
                        this.state.modoIngresoManual = e.target.value;
                        this.updateModoCalculo();
                        this.calculateAll();
                    });
                    this.elements.recuperaIva.addEventListener('change', (e) => {
                        this.state.recuperaIva = e.target.checked;
                        this.calculateAll();
                    });
                    this.elements.recuperaAnticipo.addEventListener('change', (e) => {
                        this.state.recuperaAnticipo = e.target.checked;
                        this.calculateAll();
                    });
                    this.elements.prorrateo3a.addEventListener('change', (e) => {
                        this.state.prorrateo3a = e.target.value;
                        this.calculateAll();
                    });
                    this.elements.prorrateo3b.addEventListener('change', (e) => {
                        this.state.prorrateo3b = e.target.value;
                        this.calculateAll();
                    });

                    // Listeners de inputs de impuestos
                    Object.keys(this.state.impuestos).forEach(key => {
                        const input = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`));
                        if (input) {
                            input.addEventListener('input', (e) => {
                                this.state.impuestos[key] = parseFloat(e.target.value) || 0;
                                this.calculateAll();
                            });
                        }
                    });

                    // Listeners de inputs de gastos 3a (Estimación)
                    ['despachante', 'agencia', 'otrosNac'].forEach(key => {
                        document.getElementById(`gasto-${key.toLowerCase().replace('otrosnac', 'otros-nac')}`).addEventListener('input', (e) => {
                            this.state.gastos3a[key] = parseFloat(e.target.value) || 0;
                            this.calculateAll();
                        });
                    });

                    // Listeners de inputs de gastos 3a (Liquidación)
                    ['manualArancel', 'manualDespachante', 'manualAgencia', 'manualOtrosNac', 'manualTotal', 'manualIva', 'manualAnticipo'].forEach(key => {
                        const inputId = key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`);
                        document.getElementById(inputId).addEventListener('input', (e) => {
                            this.state.gastos3a[key] = parseFloat(e.target.value) || 0;
                            this.calculateAll();
                        });
                    });
                    
                    // Listeners de inputs de gastos 3b
                    ['almacenaje', 'transporte', 'otrosPost'].forEach(key => {
                        document.getElementById(`gasto-${key.toLowerCase().replace('otrospost', 'otros-post')}`).addEventListener('input', (e) => {
                            this.state.gastos3b[key] = parseFloat(e.target.value) || 0;
                            this.calculateAll();
                        });
                    });

                    // Listeners de botones de moneda
                    document.querySelectorAll('.currency-toggle-group').forEach(group => {
                        group.addEventListener('click', (e) => {
                            const btn = e.target.closest('.currency-btn');
                            if (btn) {
                                this.handleCurrencyToggle(btn);
                            }
                        });
                    });
                    
                    // Guardado/Carga/Reset
                    this.elements.guardarBtn.addEventListener('click', () => this.saveState());
                    this.elements.cargarBtn.addEventListener('click', () => this.loadState());
                    this.elements.resetBtn.addEventListener('click', () => this.resetState());
                    
                    // Excel
                    this.elements.importExcelBtn.addEventListener('click', () => this.elements.excelFileInput.click());
                    this.elements.excelFileInput.addEventListener('change', (e) => this.handleExcelImport(e));
                    this.elements.exportExcelBtn.addEventListener('click', () => this.exportResultsToExcel());
                    this.elements.downloadTemplateBtn.addEventListener('click', () => this.downloadTemplate());

                } catch (error) {
                    console.error("Error al configurar listeners:", error);
                }
            },

            // --- NAVEGACIÓN Y UI ---

            changeTab(tabIndex) {
                if (!this.checkTipoCambio() && tabIndex > 1) {
                    this.elements.tipoCambioError.classList.remove('hidden');
                    this.changeTab(1); // Forzar vuelta al Paso 1
                    this.elements.tipoCambio.focus();
                    return;
                }
                
                this.state.currentTab = tabIndex;
                
                // Clases para el nuevo estilo de Píldora con Icono
                const activeClasses = ['bg-indigo-600', 'text-white', 'shadow-md'];
                const inactiveClasses = ['text-gray-600', 'hover:bg-gray-100', 'hover:text-gray-800'];

                this.elements.tabs.forEach((tab, index) => {
                    const isActive = index + 1 === tabIndex;
                    if (isActive) {
                        tab.classList.remove(...inactiveClasses);
                        tab.classList.add(...activeClasses);
                    } else {
                        tab.classList.remove(...activeClasses);
                        tab.classList.add(...inactiveClasses);
                    }
                });
                
                this.elements.steps.forEach((step, index) => {
                    step.classList.toggle('hidden', index + 1 !== tabIndex);
                });
                
                if (tabIndex === 4) {
                    this.calculateAll(); // Asegurar que los resultados estén actualizados
                }
            },
            
            checkTipoCambio() {
                return this.state.tipoCambio && this.state.tipoCambio > 0;
            },

            // Actualiza los campos de costo del Paso 1 según el Incoterm
            updateCostoFields() {
                const incoterm = this.state.incoterm;
                const fields = {
                    EXW: [
                        { id: 'retiro', label: 'Retiro en planta' },
                        { id: 'transporte', label: 'Transporte interno' },
                        { id: 'despacho', label: 'Despacho exportación' },
                        { id: 'thc', label: 'THC (Terminal)' },
                        { id: 'docs', label: 'Documentos' },
                        { id: 'flete', label: 'Flete Internacional' },
                        { id: 'seguro', label: 'Seguro Internacional' }
                    ],
                    FOB: [
                        { id: 'flete', label: 'Flete Internacional' },
                        { id: 'seguro', label: 'Seguro Internacional' }
                    ],
                    CFR: [
                        { id: 'seguro', label: 'Seguro Internacional' }
                    ],
                    CIF: []
                };

                this.elements.costosOrigenContainer.innerHTML = '';
                const fieldsToShow = fields[incoterm];

                if (fieldsToShow.length === 0) {
                    this.elements.costosOrigenContainer.innerHTML = '<p class="text-sm text-gray-500 md:col-span-2">Todos los costos de origen están incluidos en el Valor Base para CIF.</p>';
                } else {
                    fieldsToShow.forEach(field => {
                        this.elements.costosOrigenContainer.innerHTML += `
                            <div>
                                <label for="${field.id}" class="block text-sm font-medium text-gray-700">${field.label}</label>
                                <input type="number" id="${field.id}" value="${this.state.costosOrigen[field.id] || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            </div>
                        `;
                    });
                }
            },
            
            // Muestra/oculta la columna DAI en la tabla de productos
            updateDaiVisibility() {
                const isGlobal = this.state.modoDai === 'global';
                this.elements.daiColumn.forEach(col => col.style.display = isGlobal ? 'none' : '');
                this.elements.daiGlobalContainer.classList.toggle('hidden', !isGlobal);
                document.querySelectorAll('.dai-input-cell').forEach(cell => cell.style.display = isGlobal ? 'none' : '');
            },
            
            // Muestra/oculta los contenedores de Estimación/Liquidación
            updateModoCalculo() {
                const isEstimacion = this.state.modoCalculo === 'estimacion';
                this.elements.estimacionContainer.classList.toggle('hidden', !isEstimacion);
                this.elements.liquidacionContainer.classList.toggle('hidden', isEstimacion);
                
                if (!isEstimacion) {
                    const isDetallado = this.state.modoIngresoManual === 'detallado';
                    this.elements.manualDetalladoContainer.classList.toggle('hidden', !isDetallado);
                    this.elements.manualTotalContainer.classList.toggle('hidden', isDetallado);
                }
            },

            // Maneja el clic en los botones de moneda (Estilo Píldora deslizante)
            handleCurrencyToggle(btn) {
                try {
                    const newMoneda = btn.dataset.moneda; // 'USD' o 'UYU'
                    const group = btn.closest('.currency-toggle-group');
                    const stateObjectKey = group.dataset.stateObject; 
                    const stateKey = group.dataset.stateKey;
                    const monedaKey = `${stateKey}Moneda`;

                    if (this.state[stateObjectKey] && this.state[stateObjectKey].hasOwnProperty(monedaKey)) {
                        this.state[stateObjectKey][monedaKey] = newMoneda;
                    } else {
                        console.error(`Estado inválido: ${stateObjectKey}.${monedaKey}`);
                        return;
                    }
                    
                    // Clases de Tailwind para los estados
                    const activeClasses = ['bg-white', 'text-gray-900', 'shadow-sm'];
                    const inactiveClasses = ['text-gray-700'];

                    // Actualizar UI del grupo de botones
                    group.querySelectorAll('.currency-btn').forEach(b => {
                        b.classList.remove(...activeClasses);
                        b.classList.add(...inactiveClasses);
                    });
                    
                    btn.classList.remove(...inactiveClasses);
                    btn.classList.add(...activeClasses);
                    
                    this.calculateAll();
                } catch (error) {
                    console.error("Error en handleCurrencyToggle:", error, btn);
                }
            },

            // --- GESTIÓN DE PRODUCTOS ---

            // Dibuja la tabla de productos en el DOM
            renderProductTable() {
                this.elements.productTableBody.innerHTML = '';
                if (this.state.productos.length === 0) {
                    this.state.productos.push(this.createProduct());
                }
                
                this.state.productos.forEach(prod => {
                    const row = document.createElement('tr');
                    // Clases de "product-input"
                    const inputClasses = "product-input w-full p-2 border border-gray-300 rounded-md text-sm";
                    row.innerHTML = `
                        <td class="py-2 px-2"><input type="text" data-id="${prod.id}" data-field="nombre" value="${prod.nombre}" class="${inputClasses}" placeholder="Ej: Zapatillas"></td>
                        <td class="py-2 px-2"><input type="text" data-id="${prod.id}" data-field="ncm" value="${prod.ncm}" class="${inputClasses}" placeholder="Ej: 6404.11"></td>
                        <td class="py-2 px-2"><input type="number" data-id="${prod.id}" data-field="cantidad" value="${prod.cantidad}" class="${inputClasses}"></td>
                        <td class="py-2 px-2"><input type="number" data-id="${prod.id}" data-field="precioUnitario" value="${prod.precioUnitario}" class="${inputClasses}"></td>
                        <td class="py-2 px-2"><input type="number" data-id="${prod.id}" data-field="cbm" value="${prod.cbm}" class="${inputClasses}"></td>
                        <td class="py-2 px-2 dai-input-cell"><input type="number" data-id="${prod.id}" data-field="dai" value="${prod.dai}" class="${inputClasses} dai-column"></td>
                        <td class="py-2 px-2 text-right">
                            <button class="remove-product text-red-500 hover:text-red-700" data-id="${prod.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </td>
                    `;
                    this.elements.productTableBody.appendChild(row);
                });
                this.updateDaiVisibility();
                this.calculateAll();
            },
            
            // Crea un nuevo objeto de producto
            createProduct(data = {}) {
                return {
                    id: crypto.randomUUID(),
                    nombre: data.nombre || '',
                    ncm: data.ncm || '',
                    cantidad: data.cantidad || 1,
                    precioUnitario: data.precioUnitario || 0,
                    cbm: data.cbm || 0,
                    dai: data.dai || 0
                };
            },
            
            // Añade un producto al estado y redibuja la tabla
            addProduct() {
                this.state.productos.push(this.createProduct());
                this.renderProductTable();
            },
            
            // Quita un producto del estado y redibuja la tabla
            removeProduct(id) {
                this.state.productos = this.state.productos.filter(p => p.id !== id);
                this.renderProductTable();
            },
            
            // Actualiza el estado cuando se modifica un input de la tabla
            updateProductFromTable(input) {
                const { id, field } = input.dataset;
                const product = this.state.productos.find(p => p.id === id);
                if (product) {
                    product[field] = (input.type === 'number' ? parseFloat(input.value) : input.value) || 0;
                }
                this.calculateAll();
            },
            
            // --- CÁLCULOS PRINCIPALES ---
            
            // Función maestra que orquesta todos los cálculos
            calculateAll() {
                if (!this.state || !this.elements.totalValorBase) return; // Guard clause
                
                try {
                    // --- PASO 1 y 2: Cálculos Base ---
                    const {
                        totalValorBase,
                        totalCbm,
                        costosOrigen,
                        costoFlete,
                        costoSeguro,
                        cifTotal
                    } = this.calculateCif();

                    // Actualizar resúmenes
                    this.elements.totalValorBase.textContent = this.formatCurrency(totalValorBase, 'USD');
                    this.elements.totalCbm.textContent = `${totalCbm.toFixed(2)} m³`;
                    
                    this.elements.resumenValorBase.textContent = this.formatCurrency(totalValorBase, 'USD');
                    this.elements.resumenCostosOrigen.textContent = this.formatCurrency(costosOrigen, 'USD');
                    this.elements.resumenFlete.textContent = this.formatCurrency(costoFlete, 'USD');
                    this.elements.resumenSeguro.textContent = this.formatCurrency(costoSeguro, 'USD');
                    this.elements.resumenCifTotal.textContent = this.formatCurrency(cifTotal, 'USD');

                    // --- PASO 3: Asignación de Costos y Cálculo de Impuestos ---
                    const {
                        productosCalculados,
                        totales
                    } = this.calculateFinalCosts(totalValorBase, totalCbm, cifTotal);
                    
                    // --- PASO 4: Renderizar Resultados ---
                    this.renderResultsTable(productosCalculados);
                    this.renderGlobalTotals(totales);
                    this.renderChart(totales);
                } catch (error) {
                    console.error("Error en calculateAll:", error);
                }
            },
            
            // Calcula el Valor CIF Total
            calculateCif() {
                // 1. Calcular totales de productos
                let totalValorBase = 0;
                let totalCbm = 0;
                this.state.productos.forEach(p => {
                    const cantidad = p.cantidad || 0;
                    totalValorBase += cantidad * (p.precioUnitario || 0);
                    totalCbm += cantidad * (p.cbm || 0);
                });
                
                // 2. Calcular costos de origen
                const { retiro, transporte, despacho, thc, docs, flete, seguro } = this.state.costosOrigen;
                let costosOrigen = 0;
                let costoFlete = 0;
                let costoSeguro = 0;

                // Esto depende del incoterm
                switch (this.state.incoterm) {
                    case 'EXW':
                        costosOrigen = retiro + transporte + despacho + thc + docs;
                        costoFlete = flete;
                        costoSeguro = seguro;
                        break;
                    case 'FOB':
                        costoFlete = flete;
                        costoSeguro = seguro;
                        break;
                    case 'CFR':
                        costoSeguro = seguro;
                        break;
                    case 'CIF':
                        // Todos los costos están en el Valor Base
                        break;
                }
                
                // 3. Calcular CIF Total
                const cifTotal = totalValorBase + costosOrigen + costoFlete + costoSeguro;
                
                return { totalValorBase, totalCbm, costosOrigen, costoFlete, costoSeguro, cifTotal };
            },
            
            // Calcula los costos finales, impuestos y prorrateos por producto
            calculateFinalCosts(totalValorBase, totalCbm, cifTotal) {
                const tc = this.state.tipoCambio || 1; // Evitar división por cero
                
                // --- 1. Obtener Gastos (convertidos a USD) ---
                const gastos3a = this.getGastosNacionalizacion(tc, cifTotal);
                const gastos3b = this.getGastosPostPuerto(tc);
                
                // --- 2. Asignar Costos CIF (Paso 1) ---
                // Flete, Seguro y Costos de Origen siempre se prorratean por CBM
                const costosCIFAdicionales = cifTotal - totalValorBase;
                
                // --- 3. Calcular Totales ---
                let granTotalImpuestos = 0;
                let granTotalGastos = 0;
                let granTotalCostoNeto = 0;
                let granTotalDesembolso = 0;
                let granTotalIVA = 0;
                let granTotalAnticipo = 0;
                let granTotalAranceles = 0; // DAI + TC + TE

                const productosCalculados = this.state.productos.map(p => {
                    const cantidad = p.cantidad || 0;
                    if (cantidad === 0) return null; // Evitar división por cero

                    const valorBaseProducto = cantidad * p.precioUnitario;
                    const cbmProducto = cantidad * p.cbm;
                    
                    // --- Asignar Costos ---
                    // Asignar Costos CIF (Flete, Seguro, Origen) - Siempre por CBM
                    const pesoCBM = totalCbm > 0 ? cbmProducto / totalCbm : 0;
                    const costoCIFAsignado = valorBaseProducto + (costosCIFAdicionales * pesoCBM);

                    // Asignar Gastos 3a (Nacionalización)
                    const peso3a = this.state.prorrateo3a === 'valor' 
                        ? (totalValorBase > 0 ? valorBaseProducto / totalValorBase : 0)
                        : pesoCBM;
                    const gastos3aAsignados = gastos3a.total * peso3a;
                    
                    // Asignar Gastos 3b (Post-Puerto)
                    const peso3b = this.state.prorrateo3b === 'valor'
                        ? (totalValorBase > 0 ? valorBaseProducto / totalValorBase : 0)
                        : pesoCBM;
                    const gastos3bAsignados = gastos3b.total * peso3b;

                    const gastosTotalesAsignados = gastos3aAsignados + gastos3bAsignados;
                    
                    // --- Calcular Impuestos ---
                    let impuestos;
                    if (this.state.modoCalculo === 'estimacion') {
                        impuestos = this.calculateImpuestosEstimacion(p, costoCIFAsignado, gastos3a.baseIva);
                    } else {
                        // Modo Liquidación (Manual)
                        // Repartimos los impuestos manuales por el peso de gastos 3a (Valor Base o CBM)
                        impuestos = {
                            dai: 0, // En el modo manual, el arancel se incluye en la bolsa "arancel"
                            tasaConsular: 0,
                            tasaEstadistica: 0,
                            arancelTotal: gastos3a.impuestos.arancel * peso3a,
                            baseIva: 0, // No se usa para el cálculo, se usa el monto manual
                            iva: gastos3a.impuestos.iva * peso3a,
                            anticipoIva: gastos3a.impuestos.anticipo * peso3a,
                        };
                        impuestos.total = impuestos.arancelTotal + impuestos.iva + impuestos.anticipoIva;
                    }
                    
                    const impuestosTotalesAsignados = impuestos.arancelTotal;

                    // --- Calcular Costo Neto ---
                    let costoNetoProducto = costoCIFAsignado + impuestosTotalesAsignados + gastosTotalesAsignados;
                    
                    if (!this.state.recuperaIva) {
                        costoNetoProducto += impuestos.iva;
                    }
                    if (!this.state.recuperaAnticipo) {
                        costoNetoProducto += impuestos.anticipoIva;
                    }
                    
                    const costoNetoUnitario = costoNetoProducto / cantidad;
                    
                    // --- Sumar a Totales Globales ---
                    granTotalImpuestos += impuestosTotalesAsignados;
                    granTotalGastos += gastosTotalesAsignados;
                    granTotalCostoNeto += costoNetoProducto;
                    granTotalIVA += impuestos.iva;
                    granTotalAnticipo += impuestos.anticipoIva;
                    granTotalAranceles += impuestos.arancelTotal;
                    
                    return {
                        ...p,
                        valorCifAsignado: costoCIFAsignado,
                        impuestosTotales: impuestosTotalesAsignados,
                        gastosTotales: gastosTotalesAsignados,
                        costoNetoUnitarioUsd: costoNetoUnitario,
                        costoNetoUnitarioUyu: costoNetoUnitario * tc
                    };
                }).filter(Boolean); // Filtrar nulos
                
                granTotalDesembolso = cifTotal + granTotalImpuestos + granTotalGastos + granTotalIVA + granTotalAnticipo;
                
                const { costosOrigen, costoFlete, costoSeguro } = this.calculateCif();

                const totales = {
                    cifTotal,
                    costosOrigen: costosOrigen,
                    costoFlete: costoFlete,
                    costoSeguro: costoSeguro,
                    aranceles: granTotalAranceles,
                    gastos3a: gastos3a.total,
                    gastos3b: gastos3b.total,
                    totalCostoNetoUsd: granTotalCostoNeto,
                    totalCostoNetoUyu: granTotalCostoNeto * tc,
                    totalDesembolsoUsd: granTotalDesembolso,
                    totalDesembolsoUyu: granTotalDesembolso * tc,
                    // Para el gráfico
                    valorFOB: totalValorBase,
                };
                
                return { productosCalculados, totales };
            },
            
            // Helper para convertir gastos a USD
            gastoEnUSD(monto, moneda, tc) {
                if (tc <= 0) tc = 1; // Evitar división por cero
                return moneda === 'USD' ? monto : (monto / tc);
            },
            
            // Helper para obtener gastos 3a (Nacionalización)
            getGastosNacionalizacion(tc, cifTotal) {
                const s = this.state;
                let gastos = 0;
                let impuestos = { arancel: 0, iva: 0, anticipo: 0 };
                let baseIva = 0; // Solo para estimación

                if (s.modoCalculo === 'estimacion') {
                    // Estimación
                    gastos += this.gastoEnUSD(s.gastos3a.despachante, s.gastos3a.despachanteMoneda, tc);
                    gastos += this.gastoEnUSD(s.gastos3a.agencia, s.gastos3a.agenciaMoneda, tc);
                    gastos += this.gastoEnUSD(s.gastos3a.otrosNac, s.gastos3a.otrosNacMoneda, tc);
                    baseIva = gastos; // Base IVA para gastos
                } else {
                    // Liquidación (Manual)
                    impuestos.iva = this.gastoEnUSD(s.gastos3a.manualIva, s.gastos3a.manualIvaMoneda, tc);
                    impuestos.anticipo = this.gastoEnUSD(s.gastos3a.manualAnticipo, s.gastos3a.manualAnticipoMoneda, tc);
                    
                    if (s.modoIngresoManual === 'detallado') {
                        impuestos.arancel = this.gastoEnUSD(s.gastos3a.manualArancel, s.gastos3a.manualArancelMoneda, tc);
                        gastos += this.gastoEnUSD(s.gastos3a.manualDespachante, s.gastos3a.manualDespachanteMoneda, tc);
                        gastos += this.gastoEnUSD(s.gastos3a.manualAgencia, s.gastos3a.manualAgenciaMoneda, tc);
                        gastos += this.gastoEnUSD(s.gastos3a.manualOtrosNac, s.gastos3a.manualOtrosNacMoneda, tc);
                    } else {
                        // Modo Total: La bolsa "manualTotal" incluye aranceles y gastos
                        const totalManual = this.gastoEnUSD(s.gastos3a.manualTotal, s.gastos3a.manualTotalMoneda, tc);
                        // Asumimos que "totalManual" es la suma de aranceles + gastos
                        // Para el prorrateo, todo va a la misma bolsa.
                        gastos = totalManual;
                        impuestos.arancel = 0; // Ya está en la bolsa de "gastos"
                    }
                }
                
                return { total: gastos + impuestos.arancel, impuestos, baseIva };
            },

            // Helper para obtener gastos 3b (Post-Puerto)
            getGastosPostPuerto(tc) {
                const s = this.state.gastos3b;
                let total = 0;
                total += this.gastoEnUSD(s.almacenaje, s.almacenajeMoneda, tc);
                total += this.gastoEnUSD(s.transporte, s.transporteMoneda, tc);
                total += this.gastoEnUSD(s.otrosPost, s.otrosPostMoneda, tc);
                return { total };
            },

            // Helper para calcular impuestos (Modo Estimación)
            calculateImpuestosEstimacion(producto, costoCIFAsignado, baseIvaGastos) {
                const s = this.state.impuestos;
                
                // 1. DAI (Arancel)
                let daiPorcentaje = 0;
                if (this.state.modoDai === 'global') {
                    daiPorcentaje = s.daiGlobal;
                } else {
                    daiPorcentaje = producto.dai || 0;
                }
                const dai = costoCIFAsignado * (daiPorcentaje / 100);
                
                // 2. Tasas
                const tasaConsular = costoCIFAsignado * (s.tasaConsular / 100);
                const tasaEstadistica = costoCIFAsignado * (s.tasaEstadistica / 100);
                
                const arancelTotal = dai + tasaConsular + tasaEstadistica;
                
                // 3. IVA y Anticipo
                const cifTotalGlobal = this.calculateCif().cifTotal || 1;
                // Reparte la base de gastos (baseIvaGastos) en proporción al CIF de este producto
                const baseIvaGastosProrrateada = baseIvaGastos * (costoCIFAsignado / cifTotalGlobal);
                const baseIva = costoCIFAsignado + arancelTotal + baseIvaGastosProrrateada;
                
                const iva = baseIva * (s.iva / 100);
                const anticipoIva = iva * (s.anticipoIva / 100);
                
                return {
                    dai,
                    tasaConsular,
                    tasaEstadistica,
                    arancelTotal,
                    baseIva,
                    iva,
                    anticipoIva,
                    total: arancelTotal + iva + anticipoIva
                };
            },
            
            // --- RENDERIZADO DE RESULTADOS ---
            
            // Dibuja la tabla de resultados en el Paso 4
            renderResultsTable(productosCalculados) {
                this.elements.resultsTableBody.innerHTML = '';
                if (!productosCalculados || productosCalculados.length === 0) {
                    this.elements.resultsTableBody.innerHTML = '<tr><td colspan="7" class="py-4 px-2 text-sm text-gray-500 text-center">No hay productos para mostrar.</td></tr>';
                    return;
                }
                
                productosCalculados.forEach(p => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-3 px-2 text-sm text-gray-700">${p.nombre}</td>
                        <td class="py-3 px-2 text-sm text-gray-700">${p.cantidad}</td>
                        <td class="py-3 px-2 text-sm text-gray-700">${this.formatCurrency(p.valorCifAsignado, 'USD')}</td>
                        <td class="py-3 px-2 text-sm text-gray-700">${this.formatCurrency(p.impuestosTotales, 'USD')}</td>
                        <td class="py-3 px-2 text-sm text-gray-700">${this.formatCurrency(p.gastosTotales, 'USD')}</td>
                        <td class="py-3 px-2 text-sm font-semibold text-indigo-600">${this.formatCurrency(p.costoNetoUnitarioUsd, 'USD')}</td>
                        <td class="py-3 px-2 text-sm font-semibold text-gray-800">${this.formatCurrency(p.costoNetoUnitarioUyu, 'UYU')}</td>
                    `;
                    this.elements.resultsTableBody.appendChild(row);
                });
            },
            
            // Dibuja los totales globales en el Paso 4
            renderGlobalTotals(totales) {
                this.elements.totalCostoNetoUsd.textContent = this.formatCurrency(totales.totalCostoNetoUsd, 'USD');
                this.elements.totalCostoNetoUyu.textContent = this.formatCurrency(totales.totalCostoNetoUyu, 'UYU');
                this.elements.totalDesembolsoUsd.textContent = this.formatCurrency(totales.totalDesembolsoUsd, 'USD');
                this.elements.totalDesembolsoUyu.textContent = this.formatCurrency(totales.totalDesembolsoUyu, 'UYU');
            },
            
            // Dibuja el gráfico de torta en el Paso 4
            renderChart(totales) {
                const data = {
                    labels: [
                        'Valor FOB',
                        'Flete',
                        'Seguro',
                        'Costos Origen',
                        'Aranceles (3a)',
                        'Gastos Nacionalización (3a)',
                        'Gastos Post-Puerto (3b)'
                    ],
                    datasets: [{
                        label: 'Composición del Costo',
                        data: [
                            totales.valorFOB,
                            totales.costoFlete,
                            totales.costoSeguro,
                            totales.costosOrigen,
                            totales.aranceles,
                            Math.max(0, totales.gastos3a - totales.aranceles), // Gastos 3a sin aranceles
                            totales.gastos3b
                        ],
                        backgroundColor: [
                            '#4F46E5', // Indigo
                            '#10B981', // Emerald
                            '#3B82F6', // Blue
                            '#F59E0B', // Amber
                            '#EF4444', // Red
                            '#EC4899', // Pink
                            '#8B5CF6'  // Violet
                        ],
                        hoverOffset: 4
                    }]
                };
                
                if (this.elements.costChart) {
                    this.elements.costChart.destroy();
                }
                
                this.elements.costChart = new Chart(this.elements.costChartCanvas, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 20,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += app.formatCurrency(context.parsed, 'USD');
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            },
            
            // --- FORMATO Y UTILIDADES ---

            // Formatea un número a moneda
            formatCurrency(value, currency) {
                const tc = this.state.tipoCambio || 40; // Default para formateo si no está set
                if (currency === 'USD') {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                    }).format(value || 0);
                } else {
                    return new Intl.NumberFormat('es-UY', {
                        style: 'currency',
                        currency: 'UYU',
                    }).format(value || 0);
                }
            },
            
            // --- IMPORTACIÓN / EXPORTACIÓN ---

            // Maneja la selección de un archivo Excel
            handleExcelImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (json.length > 0) {
                        this.state.productos = [];
                        json.forEach(row => {
                            this.state.productos.push(this.createProduct({
                                nombre: row['Producto'] || '',
                                ncm: row['NCM'] || '',
                                cantidad: parseFloat(row['Cantidad']) || 0,
                                precioUnitario: parseFloat(row['Precio Unitario']) || 0,
                                cbm: parseFloat(row['CBM']) || 0,
                                dai: parseFloat(row['DAI']) || 0
                            }));
                        });
                        this.renderProductTable();
                    }
                };
                reader.readAsArrayBuffer(file);
                event.target.value = null; // Reset input
            },

            // Descarga una plantilla de Excel
            downloadTemplate() {
                const data = [
                    { 
                        'Producto': 'EJEMPLO: Zapatillas Deportivas',
                        'NCM': '6404.11',
                        'Cantidad': 100,
                        'Precio Unitario': 25.50,
                        'CBM': 0.05,
                        'DAI': 20
                    },
                    {
                        'Producto': '(Borra esta fila) Los encabezados deben ser exactos. Precio Unitario es en USD.',
                        'NCM': '',
                        'Cantidad': '',
                        'Precio Unitario': '',
                        'CBM': '',
                        'DAI': ''
                    }
                ];
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Plantilla');
                XLSX.writeFile(workbook, 'Plantilla_Importacion_Productos.xlsx');
            },

            // Exporta los resultados del Paso 4 a Excel
            exportResultsToExcel() {
                const { productosCalculados, totales } = this.calculateFinalCosts(
                    this.calculateCif().totalValorBase,
                    this.calculateCif().totalCbm,
                    this.calculateCif().cifTotal
                );

                if (productosCalculados.length === 0) {
                    // Reemplazar alert()
                    console.warn("No hay datos en los resultados para exportar.");
                    // Podrías mostrar un mensaje en la UI aquí
                    return;
                }

                const dataToExport = productosCalculados.map(p => ({
                    'Producto': p.nombre,
                    'Cantidad': p.cantidad,
                    'Valor CIF (USD Total)': p.valorCifAsignado,
                    'Total Impuestos (USD)': p.impuestosTotales,
                    'Total Gastos (USD)': p.gastosTotales,
                    'Costo Neto Unitario (USD)': p.costoNetoUnitarioUsd,
                    'Costo Neto Unitario (UYU)': p.costoNetoUnitarioUyu // Usar el número puro
                }));
                
                // Añadir fila de totales
                dataToExport.push({}); // Fila vacía
                dataToExport.push({
                    'Producto': 'TOTALES',
                    'Costo Neto Unitario (USD)': totales.totalCostoNetoUsd,
                    'Costo Neto Unitario (UYU)': totales.totalCostoNetoUyu
                });
                dataToExport.push({
                    'Producto': 'DESEMBOLSO TOTAL',
                    'Costo Neto Unitario (USD)': totales.totalDesembolsoUsd,
                    'Costo Neto Unitario (UYU)': totales.totalDesembolsoUyu
                });

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                
                // Ajustar formato de números
                productosCalculados.forEach((p, index) => {
                    const i = index + 2; // +1 por header, +1 por base 1
                    worksheet[`C${i}`] = { t: 'n', v: p.valorCifAsignado, z: '"USD" #,##0.00' };
                    worksheet[`D${i}`] = { t: 'n', v: p.impuestosTotales, z: '"USD" #,##0.00' };
                    worksheet[`E${i}`] = { t: 'n', v: p.gastosTotales, z: '"USD" #,##0.00' };
                    worksheet[`F${i}`] = { t: 'n', v: p.costoNetoUnitarioUsd, z: '"USD" #,##0.00' };
                    worksheet[`G${i}`] = { t: 'n', v: p.costoNetoUnitarioUyu, z: '"UYU" #,##0.00' };
                });

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Resultados');
                XLSX.writeFile(workbook, 'Resultados_Costos_Importacion.xlsx');
            },

            // --- GUARDADO Y ESTADO ---
            
            // Guarda el estado actual en localStorage
            saveState() {
                try {
                    localStorage.setItem('importCalculatorState', JSON.stringify(this.state));
                    // Reemplazar alert()
                    console.log("Cálculo guardado.");
                    // Aquí podrías mostrar una notificación temporal en la UI
                } catch (e) {
                    console.error("Error guardando el estado:", e);
                    // Reemplazar alert()
                    console.error("Error al guardar el estado. Es posible que el almacenamiento esté lleno.");
                }
            },
            
            // Carga el estado desde localStorage
            loadState() {
                try {
                    const savedState = localStorage.getItem('importCalculatorState');
                    if (savedState) {
                        // Restaurar estado, pero asegurando que todas las propiedades existan
                        const loadedState = JSON.parse(savedState);
                        
                        // Crear un estado base para evitar errores de "undefined"
                        const baseState = JSON.parse(JSON.stringify(app.state));
                        
                        // Fusionar con el estado default para evitar errores si el estado guardado es de una versión vieja
                        this.state = { ...baseState, ...loadedState };
                        
                        // Asegurarse que los objetos anidados también se fusionen
                        this.state.costosOrigen = { ...baseState.costosOrigen, ...loadedState.costosOrigen };
                        this.state.impuestos = { ...baseState.impuestos, ...loadedState.impuestos };
                        this.state.gastos3a = { ...baseState.gastos3a, ...loadedState.gastos3a };
                        this.state.gastos3b = { ...baseState.gastos3b, ...loadedState.gastos3b };

                        this.applyState();
                    } else {
                        // Si no hay estado guardado, aplicar el estado default de los toggles de moneda
                        this.applyCurrencyToggleState(this.state.gastos3a, ['despachante', 'agencia', 'otrosNac', 'manualArancel', 'manualDespachante', 'manualAgencia', 'manualOtrosNac', 'manualTotal', 'manualIva', 'manualAnticipo']);
                        this.applyCurrencyToggleState(this.state.gastos3b, ['almacenaje', 'transporte', 'otrosPost']);
                    }
                } catch (e) {
                    console.error("Error cargando el estado:", e);
                    localStorage.removeItem('importCalculatorState'); // Limpiar estado corrupto
                }
            },
            
            // Resetea la aplicación
            resetState() {
                // CORRECCIÓN: Reemplazar confirm() por prompt() para evitar bloqueo
                const confirmReset = prompt("¿Estás seguro de que quieres resetear todos los campos? Escribe 'RESET' para confirmar.");
                if (confirmReset === 'RESET') {
                    localStorage.removeItem('importCalculatorState');
                    window.location.reload();
                }
            },
            
            // Aplica el estado cargado a todos los inputs del DOM
            applyState() {
                // Aplicar estado a todos los campos del formulario
                this.elements.incoterm.value = this.state.incoterm;
                this.elements.tipoCambio.value = this.state.tipoCambio;
                
                this.updateCostoFields(); // Renderiza los campos de costo
                Object.keys(this.state.costosOrigen).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) input.value = this.state.costosOrigen[key];
                });
                
                this.elements.modoDai.value = this.state.modoDai;
                
                this.elements.modoCalculo.value = this.state.modoCalculo;
                this.elements.modoIngresoManual.value = this.state.modoIngresoManual;
                this.elements.recuperaIva.checked = this.state.recuperaIva;
                this.elements.recuperaAnticipo.checked = this.state.recuperaAnticipo;
                this.elements.prorrateo3a.value = this.state.prorrateo3a;
                this.elements.prorrateo3b.value = this.state.prorrateo3b;
                
                // Aplicar estado a impuestos
                Object.keys(this.state.impuestos).forEach(key => {
                    const input = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`));
                    if (input) input.value = this.state.impuestos[key];
                });
                
                // Aplicar estado a gastos 3a (Estimación)
                ['despachante', 'agencia', 'otrosNac'].forEach(key => {
                    document.getElementById(`gasto-${key.toLowerCase().replace('otrosnac', 'otros-nac')}`).value = this.state.gastos3a[key];
                });
                
                // Aplicar estado a gastos 3a (Liquidación)
                ['manualArancel', 'manualDespachante', 'manualAgencia', 'manualOtrosNac', 'manualTotal', 'manualIva', 'manualAnticipo'].forEach(key => {
                    const inputId = key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`);
                    document.getElementById(inputId).value = this.state.gastos3a[key];
                });
                
                // Aplicar estado a gastos 3b
                ['almacenaje', 'transporte', 'otrosPost'].forEach(key => {
                    document.getElementById(`gasto-${key.toLowerCase().replace('otrospost', 'otros-post')}`).value = this.state.gastos3b[key];
                });

                // Aplicar estado de monedas
                this.applyCurrencyToggleState(this.state.gastos3a, ['despachante', 'agencia', 'otrosNac', 'manualArancel', 'manualDespachante', 'manualAgencia', 'manualOtrosNac', 'manualTotal', 'manualIva', 'manualAnticipo']);
                this.applyCurrencyToggleState(this.state.gastos3b, ['almacenaje', 'transporte', 'otrosPost']);
                
                // Actualizar UI y recalcular
                this.renderProductTable(); // Ya contiene los productos del estado
                this.updateDaiVisibility();
                this.updateModoCalculo();
                this.changeTab(this.state.currentTab);
            },

            // Aplica el estado (USD/UYU) a los toggles de moneda (Estilo Píldora deslizante)
            applyCurrencyToggleState(stateObject, keys) {
                keys.forEach(key => {
                    const moneda = stateObject[`${key}Moneda`] || 'USD';
                    const group = document.querySelector(`[data-state-object="gastos3a"][data-state-key="${key}"], [data-state-object="gastos3b"][data-state-key="${key}"]`);
                    
                    if (group) {
                        const activeClasses = ['bg-white', 'text-gray-900', 'shadow-sm'];
                        const inactiveClasses = ['text-gray-700'];

                        group.querySelectorAll('.currency-btn').forEach(b => {
                            const isActive = b.dataset.moneda === moneda;
                            if (isActive) {
                                b.classList.remove(...inactiveClasses);
                                b.classList.add(...activeClasses);
                            } else {
                                b.classList.remove(...activeClasses);
                                b.classList.add(...inactiveClasses);
                            }
                        });
                    } else {
                        // No advertir, ya que algunos campos (estimación vs manual) pueden no estar en el DOM
                    }
                });
            },

            // --- Tooltip ---
            // Muestra el tooltip global
            showTooltip(event, text) {
                const trigger = event.target;
                const rect = trigger.getBoundingClientRect();
                const tooltip = this.elements.sharedTooltip;

                tooltip.innerHTML = text;
                tooltip.style.display = 'block';

                const tooltipRect = tooltip.getBoundingClientRect();
                
                // Posicionar encima del trigger
                let top = rect.top - tooltipRect.height - 7; // 7px para la flecha
                let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

                // Ajustar si se sale por la izquierda o derecha
                if (left < 0) left = 5;
                if (left + tooltipRect.width > window.innerWidth) left = window.innerWidth - tooltipRect.width - 5;
                
                // Ajustar si se sale por arriba
                if (top < 0) {
                    top = rect.bottom + 7;
                }

                tooltip.style.top = `${top + window.scrollY}px`;
                tooltip.style.left = `${left + window.scrollX}px`;
            },

            // Oculta el tooltip global
            hideTooltip() {
                this.elements.sharedTooltip.style.display = 'none';
            }

        };
        
        // Iniciar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>












